#! /usr/bin/make -f

# This is the entry point for the Cockpit integration test machinery.
#
# To run the tests manually and individually, you can do something
# like this:
#
# $ export TEST_OS=rhel-8-0
# $ ./test/run prepare
# $ ./test/check-subscriptions -v -j1 -t
#
# You need a couple of things installed for that.  At least Python 3,
# a Chromium browser, and libvirtd.  See
#
#     https://github.com/cockpit-project/cockpit/blob/master/test/README.md
#
# for more information about the Cockpit integration test machinery.

ifeq ($(TEST_OS),)
TEST_OS = rhel-8-0
endif
export TEST_OS
VM_IMAGE=$(CURDIR)/test/images/$(TEST_OS).qcow2
COCKPIT_TAR=$(CURDIR)/cockpit/subscription-manager-cockpit.tar.gz
SUBMAN_TAR=$(CURDIR)/dist/subscription-manager.tar.gz
SMBEXT_TAR=$(CURDIR)/dist/subscription-manager-build-extra.tar.gz

TEST_NODE_MODULES = node_modules/chrome-remote-interface node_modules/sizzle

check: prepare
	test/check-subscriptions

reset:
	rm -f $(COCKPIT_TAR) $(SUBMAN_TAR) $(SMBEXT_TAR) $(VM_IMAGE)

prepare: reset $(VM_IMAGE) test/common $(TEST_NODE_MODULES)

$(COCKPIT_TAR): cockpit/node_modules
	make -C cockpit dist-gzip

$(SUBMAN_TAR):
	fn=$$(python ./setup.py --fullname); \
	python ./setup.py sdist && \
        mv dist/$$fn.tar.gz $(SUBMAN_TAR)

$(SMBEXT_TAR):
	tar czf $(SMBEXT_TAR) build_ext src/subscription_manager/gui/data/icons/hicolor

$(VM_IMAGE): $(COCKPIT_TAR) $(SUBMAN_TAR) $(SMBEXT_TAR) bots
	rm -f $(VM_IMAGE)
	bots/image-customize -v $(TEST_OS) \
          -u $(COCKPIT_TAR):/var/tmp/ \
          -u $(SUBMAN_TAR):/var/tmp/ \
          -u $(SMBEXT_TAR):/var/tmp/ \
          -s ./test/vm.install

# checkout Cockpit's bots/ directory for standard test VM images and API to launch them
# must be from cockpit's master, as only that has current and existing images; but testvm.py API is stable
bots:
	git fetch --depth=1 https://github.com/cockpit-project/cockpit.git
	git checkout --force FETCH_HEAD -- bots/
	git reset bots

# checkout Cockpit's test API; this has no API stability guarantee, so check out a stable tag
# when you start a new project, use the latest relese, and update it from time to time
test/common:
	git fetch --depth=1 https://github.com/cockpit-project/cockpit.git 191
	git checkout --force FETCH_HEAD -- test/common
	git reset test/common

node_modules/%:
	npm install $*

cockpit/node_modules:
	cd cockpit/ && npm install

.PHONY: check prepare reset
